<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pareto German (Cram Mode)</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --secondary: #ec4899; --secondary-dark: #db2777;
            --bg: #f3f4f6; --card-bg: #ffffff;
            --text-main: #1f2937; --text-light: #6b7280;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text-main); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        .container { width: 100%; max-width: 900px; filter: blur(5px); pointer-events: none; transition: filter 0.3s; }
        .container.authenticated { filter: none; pointer-events: auto; }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }

        /* --- Dashboard --- */
        .hero-section {
            background: white; border-radius: 20px; padding: 25px; 
            margin-bottom: 30px; text-align: center; 
            box-shadow: var(--shadow); border: 1px solid #e5e7eb; position: relative;
        }
        .cloud-badge {
            position: absolute; top: 15px; right: 15px;
            font-size: 0.8rem; font-weight: 600; padding: 4px 10px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px;
        }
        .status-syncing { background: #e0f2fe; color: #0284c7; }
        .status-saved { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #991b1b; }
        
        .hero-title { margin-bottom: 10px; font-size: 1.5rem; color: var(--text-main); font-weight: 800; }
        
        /* Goal Bar */
        .goal-container { margin: 15px 0 25px 0; cursor: pointer; }
        .progress-bar { height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); width: 0%; transition: width 0.5s; }
        .goal-text { font-size: 0.85rem; color: var(--text-light); margin-top: 5px; display: flex; justify-content: space-between; }

        .global-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-global {
            border: none; padding: 15px; border-radius: 16px; 
            font-size: 1rem; font-weight: 700; cursor: pointer; color: white;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        .btn-global:active { transform: scale(0.98); }
        .btn-global:disabled { background: #e5e7eb; color: #9ca3af; box-shadow: none; cursor: default; }
        .bg-review { background: var(--primary); }
        .bg-new { background: var(--secondary); }
        .badge-count { background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }

        /* --- Mode Selector --- */
        .mode-label { font-size: 0.85rem; font-weight: 700; color: var(--text-light); margin-bottom: 8px; text-align: left; display: block; }
        .mode-selector {
            display: flex; background: #f3f4f6; padding: 4px; border-radius: 12px; margin-bottom: 20px;
        }
        .mode-btn {
            flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px;
            cursor: pointer; font-weight: 600; color: var(--text-light); transition: 0.2s; font-size: 0.9rem;
        }
        .mode-btn:hover { color: var(--primary); }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }


        /* --- Decks --- */
        .deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .deck-card {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: var(--shadow); transition: all 0.2s; border: 1px solid #e5e7eb;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .deck-card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Edit Deck Icon */
        .deck-edit-btn {
            position: absolute; top: 10px; right: 10px;
            width: 30px; height: 30px; border-radius: 50%;
            background: #f3f4f6; border: 1px solid #e5e7eb;
            color: var(--text-light); display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; cursor: pointer; z-index: 10; transition: all 0.2s;
        }
        .deck-edit-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        .status-bar { height: 4px; width: 100%; position: absolute; top: 0; left: 0; }
        .status-active { background: var(--warning); }
        .status-done { background: var(--success); }
        
        .deck-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; margin-top: 10px; }
        .deck-title { font-weight: 700; font-size: 1.2rem; }
        .deck-count { font-size: 0.85rem; color: var(--text-light); background: #f3f4f6; padding: 4px 8px; border-radius: 6px; }
        .deck-info { font-size: 0.9rem; font-weight: 600; color: var(--text-light); }
        .highlight-due { color: var(--warning); font-weight: 800; }
        .highlight-new { color: var(--secondary); font-weight: 800; }
        .highlight-done { color: var(--success); font-weight: 800; }

        /* --- Standard UI --- */
        .dashboard-card { background: white; border-radius: 16px; padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: 600; }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid #e5e7eb; }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; width: auto; }
        .btn-danger { color: var(--danger); border-color: #fee2e2; background: #fef2f2; }
        .btn-warning { color: #b45309; border-color: #fcd34d; background: #fffbeb; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; font-family: inherit; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: var(--text-light); }

        /* --- Auth Modal --- */
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(243, 244, 246, 0.98); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; text-align: center; }
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; color: #6b7280; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* --- Study Scene --- */
        .scene { 
            width: 100%; 
            height: 320px; 
            perspective: 1000px; /* Essential for 3D */
            margin: 20px 0; 
            cursor: pointer; 
        }
        @media (max-width: 600px) { .scene { height: 280px; } }
        
        .card { 
            width: 100%; 
            height: 100%; 
            position: relative; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; /* CRITICAL */
        }
        .card.is-flipped { transform: rotateY(180deg); }
        
        .card-face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; /* CRITICAL */
            -webkit-backface-visibility: hidden;
            background: white; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            border-radius: 20px; 
            box-shadow: var(--shadow); 
            padding: 20px; 
            text-align: center; 
            top: 0; left: 0; 
        }
        .card-face.back { transform: rotateY(180deg); border: 2px solid var(--primary); }
        
        .word-main { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
        .word-context { font-style: italic; color: var(--text-light); font-size: 1rem; }
        
        /* --- Controls (Vibrant) --- */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; opacity: 0; pointer-events: none; }
        .controls.visible { opacity: 1; pointer-events: auto; }
        
        .btn-control { 
            padding: 20px; border-radius: 16px; border: none; font-size: 1.1rem; font-weight: 800; cursor: pointer; 
            color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        .btn-control:active { transform: scale(0.96); box-shadow: none; }
        .btn-fail { background-color: #ef4444; } 
        .btn-pass { background-color: #22c55e; } 

        /* --- Table --- */
        .table-container { overflow-x: auto; max-height: 60vh; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; text-align: left; }
        th, td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        .action-cell { display: flex; gap: 5px; justify-content: flex-end; }
        
        /* Utils */
        .cefr-badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: white; }
        .cefr-badge-card { position: absolute; top: 20px; left: 20px; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cefr-a1 { background-color: #22c55e; } .cefr-a2 { background-color: #10b981; } .cefr-b1 { background-color: #3b82f6; } .cefr-u { background-color: #9ca3af; }
        .audio-container { position: absolute; top: 20px; right: 20px; z-index: 10; display: none; } 
        .btn-audio { background: rgba(238, 242, 255, 0.8); color: var(--primary); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* System Log */
        #system-log { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #1f2937; color: #10b981; font-family: monospace; font-size: 0.75rem;
            padding: 4px 10px; max-height: 100px; overflow-y: auto; z-index: 5000;
            border-top: 1px solid #374151; opacity: 0.95; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="system-log">System Initializing...</div>
    <div id="loader"><div class="spinner"></div><p style="margin-top: 15px; color: #6b7280;">Connecting...</p></div>

    <!-- AUTH -->
    <div id="auth-modal">
        <div class="auth-card">
            <h1 style="margin-bottom: 20px;">üá©üá™ Login</h1>
            <div class="tab-group"><button class="tab-btn active" onclick="app.switchAuthTab('login')">Login</button><button class="tab-btn" onclick="app.switchAuthTab('register')">Register</button></div>
            <div id="login-form">
                <input type="text" id="login-user" placeholder="Username" onkeypress="app.handleEnter(event, 'login')">
                <input type="password" id="login-pin" placeholder="PIN" onkeypress="app.handleEnter(event, 'login')">
                <button class="btn" onclick="app.login()">Login & Sync</button>
            </div>
            <div id="register-form" style="display: none;">
                <input type="text" id="reg-user" placeholder="New Username" onkeypress="app.handleEnter(event, 'register')">
                <input type="password" id="reg-pin" placeholder="Create PIN" onkeypress="app.handleEnter(event, 'register')">
                <p id="reg-error" style="color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;"></p>
                <button class="btn" onclick="app.register()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="container">
        
        <!-- LIBRARY DASHBOARD -->
        <div id="library" class="screen active">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0;">üá©üá™ Library</h2>
                <div style="font-size: 0.85rem; color: #6b7280;">
                    User: <b id="display-username">...</b> <a href="#" onclick="app.logout()" style="color: var(--danger); margin-left: 5px;">(Logout)</a>
                </div>
            </div>

            <!-- Global Review Hero -->
            <div class="hero-section">
                <div id="cloud-status" class="cloud-badge status-syncing">‚òÅÔ∏è Connecting</div>
                <div class="hero-title">Daily Focus</div>
                
                <!-- Goal Progress -->
                <div class="goal-container" onclick="app.editGoal()" title="Tap to edit goal">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:700;">Progress</span>
                        <span style="font-weight:700;"><span id="goal-learned">0</span> / <span id="goal-target">1000</span></span>
                    </div>
                    <div class="progress-bar"><div id="total-progress" class="progress-fill"></div></div>
                    <div class="goal-text"><span>Learned words</span><span>Target üéØ</span></div>
                </div>

                <!-- Study Mode Selector -->
                <span class="mode-label">Face Side:</span>
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="app.setStudyMode('DE')" id="mode-de">üá©üá™ German</button>
                    <button class="mode-btn" onclick="app.setStudyMode('EN')" id="mode-en">üá¨üáß English</button>
                    <button class="mode-btn" onclick="app.setStudyMode('MIX')" id="mode-mix">üîÄ Mixed</button>
                </div>

                <div class="global-actions">
                    <button id="btn-global-review" class="btn-global bg-review" onclick="app.startSession('global_review', null)">
                        <span>üìö Review All</span>
                        <span id="global-due-count" class="badge-count">0</span>
                    </button>
                    <button id="btn-global-new" class="btn-global bg-new" onclick="app.startSession('global_new', null)">
                        <span>‚ú® New Words</span>
                        <span id="global-new-count" class="badge-count">0</span>
                    </button>
                </div>
            </div>

            <!-- Toolbar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>üìÇ My Decks</h3>
                <div>
                    <button class="btn-sm btn-secondary" onclick="app.showVocabList(null)">üìù Edit All</button>
                    <button class="btn-sm btn-secondary" onclick="app.showImport()">‚ûï Add Deck</button>
                </div>
            </div>

            <!-- Deck List -->
            <div id="deck-list" class="deck-grid">
                <!-- Decks injected here -->
            </div>
            
            <button class="btn-sm btn-secondary btn-warning" style="margin-top: 30px; width: 100%;" onclick="app.runDiagnostics()">üõ†Ô∏è Fix Data Issues</button>
        </div>

        <!-- STUDY SCREEN -->
        <div id="study" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="color: var(--text-light); font-weight: 600;"><span id="deck-label">General</span>: <span id="session-counter">1</span></span>
                <button onclick="app.goHome()" style="background:none; border:none; cursor:pointer;">Exit</button>
            </div>

            <div class="scene" onclick="app.flipCard()">
                <div class="card" id="card-element">
                    <div class="card-face front">
                        <div id="card-cefr-badge" class="cefr-badge-card cefr-u">A1</div>
                        <!-- Front Audio -->
                        <div class="audio-container" id="front-audio-btn"><button class="btn-audio" onclick="app.speakWord(event)">üîä</button></div>
                        <div class="word-main" id="card-front-text">...</div>
                        <small style="color:#9ca3af; margin-top:10px;">Tap to flip</small>
                    </div>
                    <div class="card-face back">
                        <!-- Back Audio -->
                        <div class="audio-container" id="back-audio-btn" style="top: 10px; right: 10px;"><button class="btn-audio" onclick="app.speakWord(event)">üîä</button></div>
                        <div class="word-main" id="card-back-text">...</div>
                        <div id="card-context-text" class="word-context"></div>
                    </div>
                </div>
            </div>

            <div class="controls" id="controls-area">
                <button class="btn-control btn-fail" onclick="app.answerCard(false)">Again</button>
                <button class="btn-control btn-pass" onclick="app.answerCard(true)">Good</button>
            </div>
        </div>

        <!-- VIEW LIST (WITH EDIT & DELETE) -->
        <div id="list-view" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="list-title">All Words</h3>
                <button class="btn-sm btn-secondary" onclick="app.goHome()">Back</button>
            </div>
            <input type="text" id="search-input" placeholder="Search..." onkeyup="app.renderVocabList()">
            <div class="table-container">
                <table>
                    <thead><tr><th>German</th><th>English</th><th>Deck</th><th>Act</th></tr></thead>
                    <tbody id="vocab-table-body"></tbody>
                </table>
            </div>
            <p id="table-count" style="margin-top: 10px; color: var(--text-light); font-size: 0.9rem;"></p>
        </div>

        <!-- EDIT WORD MODAL -->
        <div id="edit-screen" class="screen">
            <div class="dashboard-card">
                <h2>‚úèÔ∏è Edit Word</h2>
                <input type="hidden" id="edit-id">
                
                <label>German Entry</label>
                <input type="text" id="edit-f">
                
                <label>English Meaning</label>
                <input type="text" id="edit-b">
                
                <label>Context / Examples</label>
                <textarea id="edit-c" rows="3"></textarea>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label>CEFR Level</label>
                        <select id="edit-cefr">
                            <option value="A1">A1</option><option value="A2">A2</option>
                            <option value="B1">B1</option><option value="B2">B2</option>
                            <option value="C1">C1</option>
                        </select>
                    </div>
                    <div>
                        <label>Deck Name</label>
                        <input type="text" id="edit-deck" list="deck-suggestions">
                        <datalist id="deck-suggestions"></datalist>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn" onclick="app.saveWordEdit()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="app.showVocabList(undefined)">Cancel</button>
                </div>
            </div>
        </div>

        <!-- IMPORT SCREEN -->
        <div id="import" class="screen">
            <div class="dashboard-card" style="text-align: left;">
                <h2 style="text-align: center;">Add Cards</h2>
                <label>Deck Name:</label>
                <input type="text" id="import-deck-name" placeholder="e.g. Lesson 1" value="General">
                
                <label>Words (CSV Format):</label>
                <p style="font-size:0.8rem; color:#6b7280; margin-bottom:5px;">German, "English", Context, CEFR</p>
                <textarea id="import-text" rows="8" placeholder='der Hund, "the dog", Der Hund ist schnell, A1'></textarea>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="app.processImport()">Save Cards</button>
                    <button class="btn btn-secondary" onclick="app.goHome()">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyABm29aJZQcCipXiBrnASs2sq6cGfDn3u8",
            authDomain: "flashcards-a3b48.firebaseapp.com",
            projectId: "flashcards-a3b48",
            storageBucket: "flashcards-a3b48.firebasestorage.app",
            messagingSenderId: "312576903829",
            appId: "1:312576903829:web:1417de83b48f38870aa99c",
            measurementId: "G-TH42LFK648"
        };
        
        window.app = {
            db: [], firestore: null, userId: null, unsubscribe: null,
            sessionQueue: [], currentCardIdx: 0, intervals: [1, 3, 7, 14, 30], batchSize: 50, voices: [], goal: 1000,
            currentDeckFilter: undefined, // undefined=all/none, string=deck name
            studyMode: 'DE', // 'DE', 'EN', 'MIX'

            init: async function() {
                const firebaseApp = initializeApp(firebaseConfig);
                const auth = getAuth(firebaseApp);
                this.firestore = getFirestore(firebaseApp);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const savedUser = localStorage.getItem('pareto_username');
                        if (savedUser) { this.userId = savedUser; this.completeLogin(savedUser); } 
                        else { document.getElementById('loader').style.display = 'none'; }
                    }
                });

                if ('speechSynthesis' in window) window.speechSynthesis.onvoiceschanged = () => this.voices = window.speechSynthesis.getVoices();
                this.setupKeyboard();
            },

            // --- AUTH ---
            switchAuthTab: function(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
                document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
                document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
            },
            handleEnter: function(e, type) { if (e.key === 'Enter') type === 'login' ? this.login() : this.register(); },

            register: async function() {
                const user = document.getElementById('reg-user').value.trim().toLowerCase();
                const pin = document.getElementById('reg-pin').value.trim();
                if (user.length < 3 || pin.length < 4) { alert("User: 3+ chars, PIN: 4+ chars."); return; }
                try {
                    const docRef = doc(this.firestore, 'users', user, 'info', 'meta');
                    const snap = await getDoc(docRef);
                    if (snap.exists()) alert("Username taken!");
                    else { await setDoc(docRef, { pin: pin, created: new Date().toISOString() }); this.completeLogin(user); }
                } catch (e) { alert("Connection Error"); }
            },

            login: async function() {
                const user = document.getElementById('login-user').value.trim().toLowerCase();
                const pin = document.getElementById('login-pin').value.trim();
                try {
                    const docRef = doc(this.firestore, 'users', user, 'info', 'meta');
                    const snap = await getDoc(docRef);
                    if (snap.exists() && snap.data().pin == pin) this.completeLogin(user);
                    else alert("Wrong User or PIN");
                } catch (e) { alert("Connection Error"); }
            },

            completeLogin: function(username) {
                this.userId = username;
                localStorage.setItem('pareto_username', username);
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('app-container').classList.add('authenticated');
                document.getElementById('display-username').textContent = username;
                this.subscribeToCloud();
            },

            logout: function() { localStorage.removeItem('pareto_username'); location.reload(); },

            // --- CLOUD SYNC ---
            subscribeToCloud: function() {
                if (!this.firestore || !this.userId) return;
                const docRef = doc(this.firestore, 'users', this.userId, 'flashcards', 'main');
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.db = data.cards || [];
                        this.goal = data.goal || 1000;
                        this.renderLibrary();
                    }
                    this.showStatus('saved');
                }, (error) => this.showStatus('error'));
            },

            saveToCloud: async function() {
                if (!this.firestore || !this.userId) return;
                this.showStatus('syncing');
                try {
                    const docRef = doc(this.firestore, 'users', this.userId, 'flashcards', 'main');
                    await setDoc(docRef, { cards: this.db, goal: this.goal, updated: new Date().toISOString() });
                } catch (error) { this.showStatus('error'); }
            },

            showStatus: function(status) {
                const el = document.getElementById('cloud-status');
                if (status === 'syncing') { el.className = 'cloud-badge status-syncing'; el.innerText = '‚òÅÔ∏è Syncing...'; }
                else if (status === 'saved') { el.className = 'cloud-badge status-saved'; el.innerText = '‚òÅÔ∏è Online'; }
                else { el.className = 'cloud-badge status-error'; el.innerText = '‚ö†Ô∏è Error'; }
            },

            // --- LIBRARY UI ---
            renderLibrary: function() {
                const now = Date.now();
                const deckListEl = document.getElementById('deck-list');
                deckListEl.innerHTML = '';

                // Group Data
                const decks = {};
                let globalDue = 0; let globalNew = 0; let globalLearned = 0;

                this.db.forEach(card => {
                    // Default deck if missing
                    if (!card.deck) card.deck = "General"; 
                    const dName = card.deck;
                    
                    if (!decks[dName]) decks[dName] = { total: 0, due: 0, new: 0, nextReview: Infinity };
                    decks[dName].total++;
                    
                    if (card.s === 'new') {
                        decks[dName].new++; globalNew++;
                    } else if (card.s === 'active' && card.due <= now) {
                        decks[dName].due++; globalDue++;
                    } else if (card.s === 'active' && card.due > now) {
                        if (card.due < decks[dName].nextReview) decks[dName].nextReview = card.due;
                    }
                    
                    if (card.s === 'active' && card.str > 0) globalLearned++;
                });

                // Update Hero Stats
                document.getElementById('global-due-count').textContent = globalDue;
                document.getElementById('global-new-count').textContent = globalNew;
                document.getElementById('btn-global-review').disabled = (globalDue === 0);
                document.getElementById('btn-global-new').disabled = (globalNew === 0);
                
                // Update Goal
                document.getElementById('goal-learned').textContent = globalLearned;
                document.getElementById('goal-target').textContent = this.goal;
                const pct = Math.min(100, (globalLearned / this.goal) * 100);
                document.getElementById('total-progress').style.width = pct + "%";

                // Render Decks
                Object.keys(decks).sort().forEach(name => {
                    const d = decks[name];
                    const div = document.createElement('div');
                    div.className = 'deck-card';
                    
                    let statusHtml = '', barClass = '', action = '';
                    const hasWork = (d.due + d.new) > 0;

                    if (hasWork) {
                        barClass = 'status-active';
                        statusHtml = `<span class="highlight-due">${d.due} Due</span> ‚Ä¢ <span class="highlight-new">${d.new} New</span>`;
                        action = `app.startSession('deck_auto', '${name}')`;
                    } else {
                        barClass = 'status-done';
                        if (d.nextReview !== Infinity) {
                            const days = Math.ceil((d.nextReview - now) / 86400000);
                            const dayText = days <= 1 ? "tomorrow" : `in ${days} days`;
                            // ADDED HINT FOR CRAM MODE
                            statusHtml = `<span class="highlight-done">‚úÖ Next: ${dayText}</span><div style="font-size:0.8rem; color:#6366f1; margin-top:5px;">Tap to Review Ahead ‚è©</div>`;
                        } else {
                            statusHtml = `<span class="highlight-done">‚úÖ All Done</span><div style="font-size:0.8rem; color:#6366f1; margin-top:5px;">Tap to Practice ‚è©</div>`;
                        }
                        // CLICKING FINISHED DECK = CRAM MODE
                        action = `app.startSession('deck_cram', '${name}')`;
                    }

                    div.innerHTML = `
                        <div class="deck-edit-btn" onclick="event.stopPropagation(); app.viewList('${name}')" title="Edit Deck">‚úèÔ∏è</div>
                        <div class="status-bar ${barClass}"></div>
                        <div class="deck-header"><div class="deck-title">${name}</div><div class="deck-count">${d.total}</div></div>
                        <div class="deck-info">${statusHtml}</div>
                    `;
                    div.setAttribute('onclick', action);
                    deckListEl.appendChild(div);
                });
                
                // Populate Datalist for Edit Suggestions
                const dl = document.getElementById('deck-suggestions');
                dl.innerHTML = '';
                Object.keys(decks).forEach(d => { dl.innerHTML += `<option value="${d}">`; });
            },

            // --- STUDY MODES ---
            setStudyMode: function(mode) {
                this.studyMode = mode;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                if (mode === 'DE') document.getElementById('mode-de').classList.add('active');
                if (mode === 'EN') document.getElementById('mode-en').classList.add('active');
                if (mode === 'MIX') document.getElementById('mode-mix').classList.add('active');
            },

            // --- SESSION ---
            startSession: function(mode, deckName) {
                const now = Date.now();
                let pool = [];

                if (mode === 'global_review') {
                    pool = this.db.filter(c => c.s === 'active' && c.due <= now);
                    document.getElementById('deck-label').textContent = "Reviewing All";
                } 
                else if (mode === 'global_new') {
                    pool = this.db.filter(c => c.s === 'new');
                    document.getElementById('deck-label').textContent = "Learning New";
                }
                else if (mode === 'deck_auto') {
                    const due = this.db.filter(c => c.deck === deckName && c.s === 'active' && c.due <= now);
                    const newC = this.db.filter(c => c.deck === deckName && c.s === 'new');
                    pool = [...due, ...newC];
                    document.getElementById('deck-label').textContent = deckName;
                }
                else if (mode === 'deck_cram') {
                    // NEW: Cram mode grabs ALL cards in deck
                    pool = this.db.filter(c => c.deck === deckName);
                    document.getElementById('deck-label').textContent = deckName + " (Cram)";
                }

                if (pool.length === 0) { alert("Nothing to study here!"); return; }

                this.sessionQueue = pool.map(c => this.db.indexOf(c));
                this.sessionQueue.sort(() => Math.random() - 0.5);
                this.sessionTotal = this.sessionQueue.length;
                this.showScreen('study'); this.loadNextCard();
            },

            loadNextCard: function() {
                if (this.sessionQueue.length === 0) { alert("Session Complete!"); this.goHome(); return; }
                document.getElementById('session-counter').textContent = (this.sessionTotal - this.sessionQueue.length + 1);
                const el = document.getElementById('card-element');
                el.classList.remove('is-flipped');
                document.getElementById('controls-area').classList.remove('visible');
                
                this.currentCardIdx = this.sessionQueue[0];
                const card = this.db[this.currentCardIdx];

                // DETERMINE SIDE based on Study Mode
                let isFrontGerman = true;
                if (this.studyMode === 'EN') isFrontGerman = false;
                else if (this.studyMode === 'MIX') isFrontGerman = Math.random() > 0.5;

                const frontText = isFrontGerman ? card.f : card.b;
                const backText = isFrontGerman ? card.b : card.f;
                
                // Show/Hide Audio buttons based on spoiler avoidance
                const frontAudio = document.getElementById('front-audio-btn');
                const backAudio = document.getElementById('back-audio-btn');
                
                frontAudio.style.display = isFrontGerman ? 'block' : 'none';
                backAudio.style.display = 'block'; // Always available on back flip

                // STANDARD IDS & SAFETY
                const frontEl = document.getElementById('card-front-text');
                if(frontEl) frontEl.textContent = frontText || "...";
                
                const badge = document.getElementById('card-cefr-badge');
                if(badge) {
                    if(card.cefr) { badge.style.display='block'; badge.innerText=card.cefr; badge.className='cefr-badge-card'; if(card.cefr.includes('A1')) badge.classList.add('cefr-a1'); }
                    else badge.style.display='none';
                }

                const backEl = document.getElementById('card-back-text');
                const contextEl = document.getElementById('card-context-text');
                if(backEl) backEl.textContent = "";
                if(contextEl) contextEl.textContent = "";
                
                setTimeout(() => {
                    if(backEl) backEl.textContent = backText || "";
                    if(contextEl) contextEl.textContent = card.c || "";
                }, 500);
            },

            flipCard: function() {
                const el = document.getElementById('card-element');
                el.classList.toggle('is-flipped');
                if (el.classList.contains('is-flipped')) setTimeout(() => document.getElementById('controls-area').classList.add('visible'), 200);
                else document.getElementById('controls-area').classList.remove('visible');
            },

            answerCard: function(correct) {
                const card = this.db[this.currentCardIdx];
                if (correct) {
                    // Success: Move to active, schedule next review
                    card.s = 'active'; card.str++;
                    card.due = Date.now() + (this.intervals[Math.min(card.str, this.intervals.length-1)] * 86400000);
                    this.sessionQueue.shift();
                } else {
                    // Fail logic: if it WAS new, keep it new (don't set to active). If active, reset streak.
                    if (card.s === 'active') {
                        card.str = 0; 
                        card.due = Date.now();
                    }
                    // For new cards, we just push them back to the queue without changing status to 'active' or setting a date yet
                    // This keeps them in the "New" bucket until "Good" is clicked.
                    this.sessionQueue.push(this.sessionQueue.shift());
                }
                this.saveToCloud(); this.loadNextCard();
            },

            // --- EDITING & LIST ---
            viewList: function(deckName) {
                this.showVocabList(deckName);
            },

            showVocabList: function(filterDeck) {
                // FIXED LOGIC: Only set filter if explicit argument passed
                // If filterDeck is undefined, we keep existing filter (e.g. from Cancel)
                if (filterDeck !== undefined) this.currentDeckFilter = filterDeck;
                
                this.showScreen('list-view');
                this.renderVocabList();
            },

            renderVocabList: function() {
                try {
                    const q = document.getElementById('search-input').value.toLowerCase();
                    const tbody = document.getElementById('vocab-table-body'); tbody.innerHTML = '';
                    
                    let filtered = this.db.filter(c => (c.f && c.f.toLowerCase().includes(q)) || (c.b && c.b.toLowerCase().includes(q)));
                    
                    // FIXED: Apply stored filter
                    if(this.currentDeckFilter) {
                        filtered = filtered.filter(c => c.deck === this.currentDeckFilter);
                        document.getElementById('list-title').textContent = this.currentDeckFilter;
                    } else {
                        document.getElementById('list-title').textContent = "All Words";
                    }
                    
                    const countEl = document.getElementById('table-count');
                    if(countEl) countEl.innerText = `Count: ${filtered.length}`;

                    filtered.forEach(c => {
                        const tr = document.createElement('tr');
                        // FIXED: Added Delete Icon üóëÔ∏è next to Edit Icon
                        tr.innerHTML = `<td><b>${c.f||""}</b></td><td>${c.b||""}</td><td>${c.deck||"General"}</td>
                        <td class="action-cell">
                            <button class="btn-sm btn-secondary" onclick="app.editWord(${c.id})">‚úèÔ∏è</button>
                            <button class="btn-sm btn-danger" onclick="app.deleteWord(${c.id})">üóëÔ∏è</button>
                        </td>`;
                        tbody.appendChild(tr);
                    });
                } catch(e) { console.error("Render List Error", e); this.log("List Err: "+e.message); }
            },

            editWord: function(id) {
                const card = this.db.find(c => c.id === id);
                if(!card) return;
                document.getElementById('edit-id').value = card.id;
                document.getElementById('edit-f').value = card.f;
                document.getElementById('edit-b').value = card.b;
                document.getElementById('edit-c').value = card.c || "";
                document.getElementById('edit-cefr').value = card.cefr || "A1";
                document.getElementById('edit-deck').value = card.deck || "General";
                this.showScreen('edit-screen');
            },

            saveWordEdit: function() {
                const id = parseFloat(document.getElementById('edit-id').value);
                const card = this.db.find(c => c.id === id);
                if(card) {
                    card.f = document.getElementById('edit-f').value;
                    card.b = document.getElementById('edit-b').value;
                    card.c = document.getElementById('edit-c').value;
                    card.cefr = document.getElementById('edit-cefr').value;
                    card.deck = document.getElementById('edit-deck').value;
                    this.saveToCloud();
                    this.showVocabList(undefined); // undefined keeps current filter
                }
            },

            deleteWord: function(id) {
                if(confirm("Delete this word?")) {
                    this.db = this.db.filter(c => c.id !== id);
                    this.saveToCloud();
                    this.renderVocabList(); // Don't need showVocabList here, just re-render is enough
                }
            },
            
            deleteWordFromEdit: function() {
                const id = parseFloat(document.getElementById('edit-id').value);
                if(confirm("Delete this word?")) {
                    this.db = this.db.filter(c => c.id !== id);
                    this.saveToCloud();
                    this.showVocabList(undefined);
                }
            },

            // --- IMPORT ---
            processImport: function() {
                const deckName = document.getElementById('import-deck-name').value.trim() || "General";
                const txt = document.getElementById('import-text').value;
                if (!txt.trim()) return;
                
                const lines = txt.split(/[\n\r]+/);
                let added = 0;
                lines.forEach(line => {
                    line = line.trim(); if(!line) return;
                    const parts = []; let current = ''; let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i]; if (char === '"') { inQuote = !inQuote; current += char; } else if (char === ',' && !inQuote) { parts.push(current); current = ''; } else { current += char; }
                    }
                    parts.push(current);
                    
                    if (parts.length >= 2) {
                        const clean = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                        const f = clean(parts[0]); const b = clean(parts[1]); const c = parts[2] ? clean(parts[2]) : ""; const cefr = parts[3] ? clean(parts[3]) : "";
                        
                        const exists = this.db.some(card => card.f.toLowerCase() === f.toLowerCase() && card.b.toLowerCase() === b.toLowerCase());
                        if (!exists && f && b) { 
                            this.db.push({ id: Date.now()+Math.random(), f: f, b: b, c: c, cefr: cefr, deck: deckName, s: 'new', str: 0, due: 0 }); 
                            added++; 
                        }
                    }
                });
                alert(`Added ${added} words to "${deckName}".`);
                document.getElementById('import-text').value = ""; this.saveToCloud(); this.goHome();
            },

            // --- UTILS ---
            speakWord: function(e) { e.stopPropagation(); if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(this.db[this.currentCardIdx].f); u.lang = 'de-DE'; window.speechSynthesis.speak(u); } },
            editGoal: function() { const g = prompt("Set Goal:", this.goal); if(g) { this.goal = parseInt(g); this.saveToCloud(); } },
            runDiagnostics: function() {
                let fix = 0;
                this.db.forEach(c => { if(!c.s){c.s='new';fix++} if(!c.deck){c.deck='General';fix++} });
                if(fix>0) { this.saveToCloud(); alert(`Fixed ${fix} items.`); } else alert("Data OK.");
            },
            resetData: function() { if(confirm("Delete ALL data?")) { this.db = []; this.saveToCloud(); } },
            log: function(msg) { const box = document.getElementById('system-log'); if(box) { box.innerText = msg; console.log(msg); } },
            
            showScreen: function(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); },
            showImport: function() { this.showScreen('import'); }, 
            goHome: function() { this.currentDeckFilter = null; this.showScreen('library'); this.renderLibrary(); },
            setupKeyboard: function() { document.addEventListener('keydown', (e) => { if (!document.getElementById('study').classList.contains('active')) return; if (e.code === 'Space') { this.flipCard(); e.preventDefault(); } else if (e.code === 'ArrowRight') this.answerCard(true); else if (e.code === 'ArrowLeft') this.answerCard(false); }); }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
