<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pareto German (Goal Fixed)</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --secondary: #ec4899; --secondary-dark: #db2777;
            --bg: #f3f4f6; --card-bg: #ffffff;
            --text-main: #1f2937; --text-light: #6b7280;
            --success: #22c55e; --danger: #ef4444;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        .container { width: 100%; max-width: 800px; filter: blur(5px); pointer-events: none; transition: filter 0.3s; }
        .container.authenticated { filter: none; pointer-events: auto; }
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }

        /* Dashboard */
        .dashboard-card { background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px; text-align: center; position: relative; }
        .cloud-badge { position: absolute; top: 15px; right: 15px; font-size: 0.8rem; font-weight: 600; padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
        .status-syncing { background: #e0f2fe; color: #0284c7; } .status-saved { background: #dcfce7; color: #166534; } .status-error { background: #fee2e2; color: #991b1b; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0; }
        .stat-box { background: #f9fafb; padding: 12px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-light); }
        
        /* CLICKABLE GOAL BOX */
        .stat-box.clickable { cursor: pointer; transition: background 0.2s; border: 2px dashed #cbd5e1; }
        .stat-box.clickable:hover { background: #e0e7ff; border-color: var(--primary); }

        /* Action Buttons */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .btn-big { border: none; padding: 20px 15px; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: transform 0.1s; color: white; display: flex; flex-direction: column; align-items: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .btn-big:active { transform: scale(0.98); }
        .btn-review { background: var(--primary); } .btn-learn { background: var(--secondary); }
        .btn-big:disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .count-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.9rem; min-width: 20px; }

        .btn { background: var(--primary); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid #e5e7eb; box-shadow: none; margin-top: 5px; padding: 12px; font-size: 1rem; }
        .btn-sm { padding: 8px 12px; font-size: 0.9rem; width: auto; display: inline-block; }
        .btn-danger { color: var(--danger); border-color: #fee2e2; background: #fef2f2; }
        .btn-warning { color: #b45309; border-color: #fcd34d; background: #fffbeb; }

        /* Auth */
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(243, 244, 246, 0.98); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .auth-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; outline: none; }
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; color: #6b7280; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Scene & Cards */
        .scene { width: 100%; height: 340px; perspective: 1000px; margin: 20px 0; cursor: pointer; }
        @media (max-width: 600px) { .scene { height: 280px; } }
        .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; border-radius: 20px; box-shadow: var(--shadow); }
        .card.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; background: var(--card-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .card-face.back { transform: rotateY(180deg); background: #fff; border: 2px solid var(--primary); }
        .word-main { font-size: 2.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 10px; }
        .word-context { font-style: italic; color: var(--text-light); margin-top: 20px; font-size: 1rem; opacity: 0.8; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 10px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .controls.visible { opacity: 1; pointer-events: auto; }
        .btn-control { padding: 20px; border-radius: 16px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        .btn-fail { background: #fee2e2; color: var(--danger); }
        .btn-pass { background: #dcfce7; color: var(--success); }

        /* Table & Misc */
        .table-container { overflow-x: auto; max-height: 60vh; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: white; text-align: left; }
        th, td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; z-index: 5; }
        .search-bar, textarea { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 10px; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .cefr-badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: white; }
        .cefr-badge-card { position: absolute; top: 20px; left: 20px; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cefr-a1 { background-color: #22c55e; } .cefr-a2 { background-color: #10b981; } .cefr-b1 { background-color: #3b82f6; } .cefr-u { background-color: #9ca3af; }
        .audio-container { position: absolute; top: 20px; right: 20px; z-index: 10; }
        .btn-audio { background: rgba(238, 242, 255, 0.8); color: var(--primary); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* Log & Loader */
        #system-log { position: fixed; bottom: 0; left: 0; width: 100%; background: #1f2937; color: #10b981; font-family: monospace; font-size: 0.75rem; padding: 4px 10px; max-height: 80px; overflow-y: auto; z-index: 5000; border-top: 1px solid #374151; opacity: 0.95; pointer-events: none; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="system-log">System Initializing...</div>
    <div id="loader"><div class="spinner"></div><p style="margin-top: 15px; color: #6b7280;">Syncing...</p></div>

    <!-- AUTH -->
    <div id="auth-modal">
        <div class="auth-card">
            <h1 style="margin-bottom: 20px;">üá©üá™ Login</h1>
            <div class="tab-group"><button class="tab-btn active" onclick="app.switchAuthTab('login')">Login</button><button class="tab-btn" onclick="app.switchAuthTab('register')">Register</button></div>
            <div id="login-form">
                <input type="text" id="login-user" class="auth-input" placeholder="Username" onkeypress="app.handleEnter(event, 'login')">
                <input type="password" id="login-pin" class="auth-input" placeholder="PIN" onkeypress="app.handleEnter(event, 'login')">
                <button class="btn" onclick="app.login()">Login & Sync</button>
            </div>
            <div id="register-form" style="display: none;">
                <input type="text" id="reg-user" class="auth-input" placeholder="New Username" onkeypress="app.handleEnter(event, 'register')">
                <input type="password" id="reg-pin" class="auth-input" placeholder="Create PIN" onkeypress="app.handleEnter(event, 'register')">
                <p id="reg-error" style="color: var(--danger); font-size: 0.9rem; margin-bottom: 5px;"></p>
                <button class="btn" onclick="app.register()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container" class="container">
        
        <div id="dashboard" class="screen active">
            <div class="dashboard-card">
                <div id="cloud-status" class="cloud-badge status-syncing">‚òÅÔ∏è Connecting</div>
                <div style="position: absolute; top: 15px; left: 15px; font-size: 0.8rem; color: #6b7280;">User: <b id="display-username">...</b> <a href="#" onclick="app.logout()" style="color: var(--danger); margin-left: 5px; text-decoration: none;">(Logout)</a></div>
                <h1 style="margin-bottom: 5px; margin-top: 10px;">üá©üá™ Dashboard</h1>
                <p style="color: var(--text-light); margin-bottom: 20px;">Pareto Principle</p>
                <div class="action-grid">
                    <button id="btn-review" class="btn-big btn-review" disabled onclick="app.startSession('review')"><span>üìö Reviews</span><span id="count-review" class="count-badge">0</span></button>
                    <button id="btn-new" class="btn-big btn-learn" disabled onclick="app.startSession('new')"><span>‚ú® New Words</span><span id="count-new" class="count-badge">0</span></button>
                </div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total Words</div></div>
                    <div class="stat-box"><div class="stat-value" id="stat-learned">0</div><div class="stat-label">Learned</div></div>
                    <div class="stat-box"><div class="stat-value" id="stat-new">0</div><div class="stat-label">New Available</div></div>
                    <!-- GOAL BOX: Explicitly clickable -->
                    <div class="stat-box clickable" onclick="app.editGoal()"><div class="stat-value" id="stat-goal">1000</div><div class="stat-label">üéØ Goal (Tap to Edit)</div></div>
                </div>
            </div>
            <div class="dashboard-card" style="padding: 16px;">
                <h3 style="margin-bottom: 12px;">Tools</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn btn-secondary" onclick="app.showVocabList()">üìñ View List</button>
                    <button class="btn btn-secondary" onclick="app.showImport()">üì• Add Words</button>
                </div>
                <button class="btn btn-secondary btn-warning" style="margin-top:10px;" onclick="app.runDiagnostics()">üõ†Ô∏è Fix Database (Ghost Words)</button>
                <button class="btn btn-secondary btn-danger" style="margin-top:5px;" onclick="app.resetData()">üóëÔ∏è Reset Data</button>
            </div>
        </div>

        <div id="study" class="screen">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: 600; color: var(--text-light);"><span id="session-mode-label">Review</span>: <span id="session-counter">1</span>/50</span>
                <button onclick="app.goHome()" style="background:none; border:none; color: var(--text-light); cursor:pointer;">Exit</button>
            </div>
            <div class="scene" onclick="app.flipCard()">
                <div class="card" id="card-element">
                    <div class="card-face front">
                        <div id="card-cefr-badge" class="cefr-badge-card cefr-u">A1</div>
                        <div class="audio-container"><button class="btn-audio" onclick="app.speakWord(event)">üîä</button></div>
                        <div class="word-main" id="card-front-text">...</div>
                        <div class="tap-hint">Tap to Flip</div>
                    </div>
                    <div class="card-face back">
                        <div class="word-main" id="card-back-text">...</div>
                        <div class="word-context" id="card-context-text"></div>
                    </div>
                </div>
            </div>
            <div class="controls" id="controls-area">
                <button class="btn-control btn-fail" onclick="app.answerCard(false)">‚ùå Forgot</button>
                <button class="btn-control btn-pass" onclick="app.answerCard(true)">‚úÖ I Know It</button>
            </div>
        </div>

        <div id="vocab" class="screen">
            <div class="dashboard-card" style="text-align: left; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"><h2>List</h2><button class="btn btn-sm btn-secondary" onclick="app.goHome()">Back</button></div>
                <input type="text" id="search-input" class="search-bar" placeholder="Search..." onkeyup="app.renderVocabList()">
                <div id="bulk-actions" style="margin-bottom: 10px; display: none;"><button class="btn btn-sm btn-danger" onclick="app.deleteSelected()">üóëÔ∏è Delete (<span id="selected-count">0</span>)</button></div>
                <div class="table-container"><table><thead><tr><th style="width: 40px;"><input type="checkbox" id="select-all" onclick="app.toggleSelectAll()"></th><th>Word</th><th>Meaning</th><th>Lvl</th><th>Act</th></tr></thead><tbody id="vocab-table-body"></tbody></table></div>
                <p id="table-count" style="margin-top: 10px; color: var(--text-light); font-size: 0.9rem;"></p>
            </div>
        </div>

        <div id="import" class="screen">
            <div class="dashboard-card">
                <h2>Add Words</h2>
                <textarea id="import-area" rows="10" placeholder='der Hund, "the dog", Der Hund ist schnell, A1'></textarea>
                <div style="display: flex; gap: 10px; margin-top: 10px;"><button class="btn" onclick="app.processImport()">Save</button><button class="btn btn-secondary" onclick="app.goHome()">Cancel</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === USER'S LIVE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyABm29aJZQcCipXiBrnASs2sq6cGfDn3u8",
            authDomain: "flashcards-a3b48.firebaseapp.com",
            projectId: "flashcards-a3b48",
            storageBucket: "flashcards-a3b48.firebasestorage.app",
            messagingSenderId: "312576903829",
            appId: "1:312576903829:web:1417de83b48f38870aa99c",
            measurementId: "G-TH42LFK648"
        };
        
        window.app = {
            db: [], firestore: null, userId: null, unsubscribe: null,
            sessionQueue: [], currentCardIdx: null, intervals: [1, 3, 7, 14, 30], batchSize: 50, voices: [],
            goal: 1000,

            init: async function() {
                const firebaseApp = initializeApp(firebaseConfig);
                const auth = getAuth(firebaseApp);
                this.firestore = getFirestore(firebaseApp);
                this.log("Connecting...");

                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const savedUser = localStorage.getItem('pareto_username');
                        if (savedUser) {
                            this.userId = savedUser;
                            this.completeLogin(savedUser);
                        } else {
                            document.getElementById('loader').style.display = 'none';
                        }
                    }
                });

                if ('speechSynthesis' in window) window.speechSynthesis.onvoiceschanged = () => this.voices = window.speechSynthesis.getVoices();
                this.setupKeyboard();
            },

            // --- AUTH ---
            switchAuthTab: function(tab) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
                document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
                document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
            },
            handleEnter: function(e, type) { if (e.key === 'Enter') type === 'login' ? this.login() : this.register(); },

            register: async function() {
                const user = document.getElementById('reg-user').value.trim().toLowerCase();
                const pin = document.getElementById('reg-pin').value.trim();
                if (user.length < 3 || pin.length < 4) { alert("User: 3+ chars, PIN: 4+ chars."); return; }
                try {
                    const docRef = doc(this.firestore, 'users', user, 'info', 'meta');
                    const snap = await getDoc(docRef);
                    if (snap.exists()) alert("Username taken!");
                    else { await setDoc(docRef, { pin: pin, created: new Date().toISOString() }); this.completeLogin(user); }
                } catch (e) { this.log("Error: " + e.message); }
            },

            login: async function() {
                const user = document.getElementById('login-user').value.trim().toLowerCase();
                const pin = document.getElementById('login-pin').value.trim();
                try {
                    const docRef = doc(this.firestore, 'users', user, 'info', 'meta');
                    const snap = await getDoc(docRef);
                    if (snap.exists() && snap.data().pin == pin) this.completeLogin(user);
                    else alert("Wrong User or PIN");
                } catch (e) { this.log("Error: " + e.message); }
            },

            completeLogin: function(username) {
                this.userId = username;
                localStorage.setItem('pareto_username', username);
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('app-container').classList.add('authenticated');
                document.getElementById('display-username').textContent = username;
                this.subscribeToCloud();
            },

            logout: function() { localStorage.removeItem('pareto_username'); location.reload(); },

            // --- REALTIME CLOUD LISTENER ---
            subscribeToCloud: function() {
                if (!this.firestore || !this.userId) return;
                this.log(`Syncing as: ${this.userId}`);
                
                const docRef = doc(this.firestore, 'users', this.userId, 'flashcards', 'main');
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.db = data.cards || [];
                        this.goal = data.goal || 1000;
                        this.log(`Data Sync: Received ${this.db.length} cards.`);
                        this.updateDashboard(); 
                    } else {
                        this.log("No cloud data found.");
                        this.db = [];
                        this.updateDashboard();
                    }
                    this.showStatus('saved');
                }, (error) => {
                    this.log("Sync Error: " + error.message);
                    this.showStatus('error');
                });
            },

            // --- THE FIXER FUNCTION ---
            runDiagnostics: function() {
                if(!this.db || this.db.length === 0) { alert("Database is empty. Nothing to fix."); return; }
                let fixedCount = 0;
                this.db.forEach(c => {
                    let dirty = false;
                    if (!c.s || (c.s !== 'new' && c.s !== 'active')) { c.s = 'new'; dirty = true; }
                    if (!c.due || isNaN(c.due)) { c.due = 0; dirty = true; }
                    if (!c.str || isNaN(c.str)) { c.str = 0; dirty = true; }
                    if(dirty) fixedCount++;
                });
                if(fixedCount > 0) { this.saveToCloud(); alert(`‚úÖ Fixed ${fixedCount} broken words! Check the dashboard now.`); }
                else { alert("Database looks healthy! No issues found."); }
            },

            saveToCloud: async function() {
                if (!this.firestore || !this.userId) return;
                this.showStatus('syncing');
                try {
                    const docRef = doc(this.firestore, 'users', this.userId, 'flashcards', 'main');
                    await setDoc(docRef, { cards: this.db, goal: this.goal, updated: new Date().toISOString() });
                } catch (error) { this.log("Save Failed: " + error.message); }
            },

            editGoal: function() {
                const g = prompt("Set your learning goal (e.g., 1000):", this.goal);
                if (g && !isNaN(g)) {
                    this.goal = parseInt(g);
                    this.saveToCloud();
                }
            },

            log: function(msg) {
                const box = document.getElementById('system-log');
                box.innerText = msg;
                console.log(msg);
            },

            showStatus: function(status) {
                const el = document.getElementById('cloud-status');
                if (status === 'syncing') { el.className = 'cloud-badge status-syncing'; el.innerText = '‚òÅÔ∏è Syncing...'; }
                else if (status === 'saved') { el.className = 'cloud-badge status-saved'; el.innerText = '‚òÅÔ∏è Online'; }
                else { el.className = 'cloud-badge status-error'; el.innerText = '‚ö†Ô∏è Error'; }
            },

            resetData: function() { if(confirm("DELETE all data?")) { this.db = []; this.saveToCloud(); } },

            // --- DASHBOARD ---
            updateDashboard: function() {
                try {
                    const now = Date.now();
                    let reviews = 0, newWords = 0, learned = 0;
                    if (this.db && Array.isArray(this.db)) {
                        reviews = this.db.filter(c => c.s === 'active' && c.due <= now).length;
                        newWords = this.db.filter(c => c.s === 'new').length;
                        learned = this.db.filter(c => c.s === 'active' && c.str > 0).length;
                    }
                    this.log(`UI Update: Rev=${reviews}, New=${newWords}, Total=${this.db.length}`);
                    const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
                    setText('stat-total', this.db.length);
                    setText('stat-learned', learned);
                    setText('stat-due', reviews);
                    setText('stat-new', newWords);
                    setText('stat-goal', this.goal || 1000); 
                    setText('count-review', reviews);
                    setText('count-new', newWords);
                    const btnReview = document.getElementById('btn-review'); if(btnReview) btnReview.disabled = (reviews === 0);
                    const btnNew = document.getElementById('btn-new'); if(btnNew) btnNew.disabled = (newWords === 0);
                } catch (e) { console.error("Dashboard Error:", e); this.log("UI Error: " + e.message); }
            },

            processImport: function() {
                const txt = document.getElementById('import-area').value;
                if (!txt.trim()) return;
                const lines = txt.split(/[\n\r]+/);
                let added = 0;
                lines.forEach(line => {
                    line = line.trim(); if(!line) return;
                    const parts = []; let current = ''; let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i]; if (char === '"') { inQuote = !inQuote; current += char; } else if (char === ',' && !inQuote) { parts.push(current); current = ''; } else { current += char; }
                    }
                    parts.push(current);
                    if (parts.length >= 2) {
                        const clean = (s) => s ? s.trim().replace(/^"|"$/g, '') : "";
                        const f = clean(parts[0]); const b = clean(parts[1]); const c = parts[2] ? clean(parts[2]) : ""; const cefr = parts[3] ? clean(parts[3]) : "";
                        const exists = this.db.some(card => card.f.toLowerCase() === f.toLowerCase() && card.b.toLowerCase() === b.toLowerCase());
                        if (!exists && f && b) { this.db.push({ id: Date.now()+Math.random(), f: f, b: b, c: c, cefr: cefr, s: 'new', str: 0, due: 0 }); added++; }
                    }
                });
                this.log(`Imported ${added} words.`);
                document.getElementById('import-area').value = ""; this.saveToCloud(); this.goHome();
            },

            // --- SESSION ---
            startSession: function(mode) {
                const now = Date.now();
                let pool = [];
                if (mode === 'review') pool = this.db.map((c, i) => ({...c, idx: i})).filter(c => c.s === 'active' && c.due <= now).map(c => c.idx);
                else pool = this.db.map((c, i) => ({...c, idx: i})).filter(c => c.s === 'new').map(c => c.idx);
                
                this.sessionQueue = pool.slice(0, this.batchSize);
                if (this.sessionQueue.length === 0) { alert("No cards!"); return; }
                this.sessionTotal = this.sessionQueue.length;
                this.sessionQueue.sort(() => Math.random() - 0.5);
                this.showScreen('study'); this.loadNextCard();
            },

            loadNextCard: function() {
                if (this.sessionQueue.length === 0) { alert("Done!"); this.goHome(); return; }
                document.getElementById('session-counter').textContent = (this.sessionTotal - this.sessionQueue.length + 1);
                const el = document.getElementById('card-element');
                el.classList.remove('is-flipped');
                document.getElementById('controls-area').classList.remove('visible');
                this.currentCardIdx = this.sessionQueue[0];
                const card = this.db[this.currentCardIdx];
                document.getElementById('card-front-text').textContent = card.f;
                const badgeEl = document.getElementById('card-cefr-badge');
                if (card.cefr) {
                    badgeEl.style.display = 'block'; badgeEl.textContent = card.cefr; badgeEl.className = 'cefr-badge-card'; 
                    const lvl = card.cefr.toLowerCase();
                    if(lvl.includes('a1')) badgeEl.classList.add('cefr-a1');
                    else if(lvl.includes('a2')) badgeEl.classList.add('cefr-a2');
                    else if(lvl.includes('b1')) badgeEl.classList.add('cefr-b1');
                    else badgeEl.classList.add('cefr-u');
                } else { badgeEl.style.display = 'none'; }
                document.getElementById('card-back-text').textContent = "";
                document.getElementById('card-context-text').textContent = "";
                setTimeout(() => { document.getElementById('card-back-text').textContent = card.b; document.getElementById('card-context-text').textContent = card.c; }, 500);
            },

            flipCard: function() {
                const el = document.getElementById('card-element');
                const controls = document.getElementById('controls-area');
                el.classList.toggle('is-flipped');
                if (el.classList.contains('is-flipped')) setTimeout(() => controls.classList.add('visible'), 200); else controls.classList.remove('visible');
            },

            answerCard: function(correct) {
                if (!document.getElementById('card-element').classList.contains('is-flipped')) return;
                const card = this.db[this.currentCardIdx];
                if (correct) {
                    card.s = 'active'; card.str++;
                    card.due = Date.now() + (this.intervals[Math.min(card.str, this.intervals.length-1)] * 86400000);
                    this.sessionQueue.shift();
                } else {
                    card.s = 'active'; card.str = 0; card.due = Date.now();
                    this.sessionQueue.push(this.sessionQueue.shift());
                }
                this.saveToCloud(); this.loadNextCard();
            },

            speakWord: function(e) { e.stopPropagation(); if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(this.db[this.currentCardIdx].f); u.lang = 'de-DE'; window.speechSynthesis.speak(u); } },
            showScreen: function(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); },
            showVocabList: function() { this.showScreen('vocab'); this.renderVocabList(); }, showImport: function() { this.showScreen('import'); }, goHome: function() { this.showScreen('dashboard'); this.updateDashboard(); },
            
            // --- SAFE LIST RENDER ---
            renderVocabList: function() {
                try {
                    if (!this.db || !Array.isArray(this.db)) return;
                    const q = (document.getElementById('search-input').value || "").toLowerCase();
                    const tbody = document.getElementById('vocab-table-body'); tbody.innerHTML = '';
                    
                    const filtered = this.db.filter(c => {
                        if (!c) return false;
                        const f = String(c.f || "").toLowerCase();
                        const b = String(c.b || "").toLowerCase();
                        return f.includes(q) || b.includes(q);
                    });
                    
                    // Fixed: Added check for element existence
                    const countEl = document.getElementById('table-count');
                    if (countEl) countEl.innerText = `Count: ${filtered.length}`;
                    
                    document.getElementById('select-all').checked = false; this.updateBulkButton();
                    
                    filtered.forEach(c => {
                        const tr = document.createElement('tr');
                        const f = c.f || "(Empty)";
                        const b = c.b || "(Empty)";
                        tr.innerHTML = `<td><input type="checkbox" class="select-row" value="${c.id}" onchange="app.updateBulkButton()"></td><td><b>${f}</b></td><td>${b}</td><td>${c.cefr||""}</td><td>${c.str}</td><td style="text-align: right;"><button class="btn-sm btn-danger" onclick="app.deleteWord(${c.id})">üóëÔ∏è</button></td>`;
                        tbody.appendChild(tr);
                    });
                } catch(e) {
                    console.error(e);
                    this.log("List Render Error: " + e.message);
                }
            },
            deleteWord: function(id) { if(confirm("Delete word?")) { this.db = this.db.filter(c => c.id !== id); this.saveToCloud(); this.renderVocabList(); } },
            toggleSelectAll: function() { const isChecked = document.getElementById('select-all').checked; document.querySelectorAll('.select-row').forEach(cb => cb.checked = isChecked); this.updateBulkButton(); },
            updateBulkButton: function() { const count = document.querySelectorAll('.select-row:checked').length; const btn = document.getElementById('bulk-actions'); if (count > 0) { btn.style.display = 'block'; document.getElementById('selected-count').innerText = count; } else { btn.style.display = 'none'; } },
            deleteSelected: function() { const checkedBoxes = document.querySelectorAll('.select-row:checked'); const count = checkedBoxes.length; if (count === 0) return; if (confirm(`Delete ${count} words?`)) { const idsToDelete = Array.from(checkedBoxes).map(cb => parseFloat(cb.value)); this.db = this.db.filter(c => !idsToDelete.includes(c.id)); this.saveToCloud(); this.renderVocabList(); } },
            setupKeyboard: function() { document.addEventListener('keydown', (e) => { if (!document.getElementById('study').classList.contains('active')) return; if (e.code === 'Space') { this.flipCard(); e.preventDefault(); } else if (e.code === 'ArrowRight') this.answerCard(true); else if (e.code === 'ArrowLeft') this.answerCard(false); }); },
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
